
(function(){var app=angular.module("crowdsupport.admin",["ui.router","crowdsupport.widget.citySearch"]);app.config(function($locationProvider,$stateProvider,$urlRouterProvider){$locationProvider.html5Mode(true);$urlRouterProvider.otherwise(function($injector,$location){if($location.$$url.indexOf("admin")<=-1){window.location.reload(true);}
return $location;});$stateProvider.state("overview",{url:"/admin",templateUrl:"/template/admin/overview.html"}).state("requestedPlaces",{url:"/admin/requestedPlaces",templateUrl:"/template/admin/requestedPlaces.html",controller:"RequestedPlacesCtrl as ctrl"});});app.controller("RequestedPlacesCtrl",function($http,$scope){$scope.allRequests={};$http.get("/service/v1/place/request").then(function(response){$scope.allRequests=response.data;},null);$scope.initRequest=function(request){var citySelected=request.place.city!==null;request.ui={citySearch:citySelected,stateSearch:citySelected,setCitySearch:function(citySearch){if(citySearch==false){}
request.ui.citySearch=citySearch;},setStateSearch:function(stateSearch){if(stateSearch==false){}
request.ui.stateSearch=stateSearch;}};};});})();

(function(){var app=angular.module("crowdsupport",["timeAgo","crowdsupport.services","crowdsupport.admin","crowdsupport.widget.citySearch"]);app.directive("donationRequests",function(){return{restrict:'E',templateUrl:'/template/donation-requests.html',controller:["$scope","$http",function($scope,$http){var that=this;$scope.donationRequests=[];this.identifier=(function(){var url=window.location.href;var position=url.search(/support\//)+8;return url.substring(position);})();$http.get(SERVICE_PREFIX+this.identifier+"/donationRequests").success(function(data){that.donationRequests=data;});}],controllerAs:'ctrl'}});app.controller("LoginCtrl",function($scope,$rootScope){$rootScope.user=null;$scope.setUser=function(userJson){$rootScope.user=angular.fromJson(userJson);};});app.controller("DonationRequestCtrl",function($scope,CommentService){var that=this;var donationRequest={};$scope.comment="";this.init=function(donationRequest){that.donationRequest=donationRequest;};this.addComment=function(){console.log("Comment for request "+that.donationRequest.id+": "+$scope.comment);var commentDto={"text":$scope.comment,"quantity":0,"donationRequestId":that.donationRequest.id};CommentService.send(commentDto);$scope.comment="";};CommentService.receive().then(null,null,function(message){if(message.changeType=="ADD"&&message.entity=="CommentDto"){message=message.payload;if(that.donationRequest.id==message.donationRequestId){that.donationRequest.comments.push(message);}}});});app.controller("PlaceRequestCtrl",function($scope,$http){$scope.city={};$scope.name="";$scope.identifier="";$scope.location="";$scope.cityname="";$scope.statename="";$scope.addCity=false;$scope.addCityInfo=function(){$scope.cityname=$scope.city;$scope.addCity=true;};$scope.searchCity=function(){$scope.addCity=false;}
this.submit=function(){var formData={place:{name:$scope.name,identifier:$scope.identifier,location:$scope.location}};if(!$scope.addCity){formData.place.city=$scope.city;}else{formData.city=$scope.cityname;formData.state=$scope.statename;}
var url="/service/v1/place/request";$http.post(url,formData).then(function(response){alert("Success");},function(response){alert("Oh oh");});};});})();

var SERVICE_PREFIX="/service/v1/";var nullOrEmpty=function(obj){return obj!=null&&Object.keys(obj).length!=0;};

(function(){var app=angular.module("crowdsupport.services",[]);app.service("CommentService",function($q,$timeout){var service={},listener=$q.defer(),socket={client:null,stomp:null};service.RECONNECT_TIMEOUT=30000;service.IDENTIFIER=(function(){var url=window.location.href;var position=url.search(/support\//)+8;return url.substring(position);})();service.SOCKET_URL="/ws";service.CHAT_TOPIC="/topic/"+service.IDENTIFIER+"/comments";service.CHAT_BROKER="/app/"+service.IDENTIFIER+"/comments";service.receive=function(){return listener.promise;};service.send=function(comment){socket.stomp.send(service.CHAT_BROKER,{priority:9},JSON.stringify(comment));};var reconnect=function(){$timeout(function(){initialize();},this.RECONNECT_TIMEOUT);};var getComment=function(data){return JSON.parse(data);};var startListener=function(){socket.stomp.subscribe(service.CHAT_TOPIC,function(data){listener.notify(getComment(data.body));});};var initialize=function(){socket.client=new SockJS(service.SOCKET_URL);socket.stomp=Stomp.over(socket.client);socket.stomp.connect({},startListener);socket.stomp.onclose=reconnect;};initialize();return service;});})();

angular.module('timeAgo',[]).directive("timeAgo",function($q){return{restrict:"C",scope:{title:'@'},link:function(scope,element,attrs){var parsedDate=$q.defer();parsedDate.promise.then(function(){jQuery(element).timeago();});attrs.$observe('title',function(newValue){parsedDate.resolve(newValue);});}};});

(function(){angular.module('crowdsupport.widget.citySearch',['ui.bootstrap']).directive("citySearch",function(){return{restrict:"E",transclude:true,scope:{ngModel:"=",inputClass:"@",inputId:"@"},controller:function($scope,$http){$scope.queryCities=function(query){return $http.get(SERVICE_PREFIX+"city",{params:{query:query}}).then(function(response){return response.data;});};$scope.formatInput=function(model){return nullOrEmpty(model)?model.name+" ("+model.state.name+")":"";};},templateUrl:"/template/widget/citySearch/citySearch.html"};});})();
