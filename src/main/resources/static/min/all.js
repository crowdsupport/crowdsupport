
(function(){var app=angular.module("crowdsupport.admin",["ui.router","crowdsupport.widget.citySearch"]);app.config(function($locationProvider,$stateProvider,$urlRouterProvider){$locationProvider.html5Mode(true);$urlRouterProvider.otherwise(function($injector,$location){if($location.$$url.indexOf("admin")<=-1){window.location.reload(true);}
return $location;});$stateProvider.state("overview",{url:"/admin",templateUrl:"/template/admin/overview.html"}).state("requestedPlaces",{url:"/admin/requestedPlaces",templateUrl:"/template/admin/requestedPlaces.html",controller:"RequestedPlacesCtrl as ctrl"});});app.controller("RequestedPlacesCtrl",function($http,$scope){$scope.allRequests={};$http.get("/service/v1/place/request").then(function(response){$scope.allRequests=response.data;},null);$scope.initRequest=function(request){var citySelected=request.place.city!==null;request.ui={citySearch:citySelected,stateSearch:citySelected,setCitySearch:function(citySearch){if(citySearch==false){}
request.ui.citySearch=citySearch;},setStateSearch:function(stateSearch){if(stateSearch==false){}
request.ui.stateSearch=stateSearch;}};};});})();

(function(){var app=angular.module("crowdsupport",["timeAgo","crowdsupport.service.websocket","crowdsupport.admin","crowdsupport.widget.citySearch"]);app.directive("donationRequests",function(){return{restrict:'E',templateUrl:'/template/donation-requests.html',controller:["$scope","$http",function($scope,$http){var that=this;$scope.donationRequests=[];this.identifier=(function(){var url=window.location.href;var position=url.search(/support\//)+8;return url.substring(position);})();$http.get(SERVICE_PREFIX+this.identifier+"/donationRequests").success(function(data){that.donationRequests=data;});}],controllerAs:'ctrl'}});app.controller("LoginCtrl",function($scope,$rootScope){$rootScope.user=null;$scope.setUser=function(userJson){$rootScope.user=angular.fromJson(userJson);};});app.controller("DonationRequestCtrl",function($scope,Websocket){var that=this;var donationRequest={};$scope.comment="";this.init=function(donationRequest){that.donationRequest=donationRequest;};var identifier=getUrlAfterSupport()+"/comments";this.addComment=function(){console.log("Comment for request "+that.donationRequest.id+": "+$scope.comment);var commentDto={"text":$scope.comment,"quantity":0,"donationRequestId":that.donationRequest.id};Websocket.send(identifier,commentDto);$scope.comment="";};Websocket.when(identifier).then(null,null,function(message){if(message.changeType=="ADD"&&message.entity=="CommentDto"){message=message.payload;if(that.donationRequest.id==message.donationRequestId){that.donationRequest.comments.push(message);}}});});app.controller("PlaceRequestCtrl",function($scope,$http){$scope.city={};$scope.name="";$scope.identifier="";$scope.location="";$scope.cityname="";$scope.statename="";$scope.addCity=false;$scope.addCityInfo=function(){$scope.cityname=$scope.city;$scope.addCity=true;};$scope.searchCity=function(){$scope.addCity=false;}
this.submit=function(){var formData={place:{name:$scope.name,identifier:$scope.identifier,location:$scope.location}};if(!$scope.addCity){formData.place.city=$scope.city;}else{formData.city=$scope.cityname;formData.state=$scope.statename;}
var url="/service/v1/place/request";$http.post(url,formData).then(function(response){alert("Success");},function(response){alert("Oh oh");});};});})();

var SERVICE_PREFIX="/service/v1/";var nullOrEmpty=function(obj){return obj!=null&&Object.keys(obj).length!=0;};var getUrlAfterSupport=function(){var url=window.location.href;var position=url.search(/support\//)+8;return url.substring(position);};

(function(){angular.module("crowdsupport.service.websocket",[]).service("Websocket",function($q,$timeout,$log){var that=this;var SOCKET_URL="/ws";var TOPIC_PREFIX="/topic/";var BROKER_PREFIX="/app/";var RECONNECT_TIMEOUT=30000;var client=new SockJS(SOCKET_URL);var stomp=Stomp.over(client);stomp.onclose=function(){$timeout(function(){$log.debug("Connection lost...");that.connect();},RECONNECT_TIMEOUT);};var started=false;this.ready=false;var topics=[];var sendBuffer=[];var getTopic=function(address){var t=$.grep(topics,function(topic,i){return topic.address==address;});if(t.length!=0){return t[0];}else{var newT={address:address,subscription:null,bufferedSubscription:null,deferred:$q.defer()};topics.push(newT);return newT;}};var connectIfNeeded=function(){if(!started){that.connect();}};this.send=function(broker,data){var url=BROKER_PREFIX+broker;connectIfNeeded();var sending=function(){$log.debug("Sending message to "+url);$log.debug(data);stomp.send(BROKER_PREFIX+broker,{priority:9},JSON.stringify(data));};if(that.ready){sending();}else{$log.debug("Websocket not ready yet... buffering message to "+url);$log.debug(data);sendBuffer.push(sending);}};this.when=function(address){connectIfNeeded();var url=TOPIC_PREFIX+address;var topic=getTopic(url);var subscribe=function(){$log.debug("Subscribing to "+url);topic.subscription=stomp.subscribe(url,function(data){$log.debug("Received data from "+url);$log.debug(data);topic.deferred.notify(JSON.parse(data.body));});};if(topic.subscription===null){if(that.ready){subscribe();}else if(topic.bufferedSubscription===null){$log.debug("Websocket not ready yet... buffering subscription for "+url);topic.bufferedSubscription=subscribe;}}
return topic.deferred.promise;};this.connect=function(){$log.debug("Starting Websocket...");started=true;stomp.connect({},function(){that.ready=true;$log.debug("...Websocket ready");$log.debug("Clearing subscription buffer...");topics.forEach(function(topic){if(topic.bufferedSubscription!==null){topic.bufferedSubscription();topic.bufferedSubscription=null;}});$log.debug("...subscription buffer cleared");$log.debug("Clearing message buffer");sendBuffer.forEach(function(sendMessage){sendMessage();});sendBuffer.length=0;$log.debug("Message buffer cleared");});};this.disconnect=function(){that.ready=false;$log.debug("Disconnecting Websocket...");stomp.disconnect(function(){started=false;$log.debug("...Websocket disconnected");});};});})();

(function(){angular.module('crowdsupport.widget.citySearch',['ui.bootstrap']).directive("citySearch",function(){return{restrict:"E",transclude:true,scope:{ngModel:"=",inputClass:"@",inputId:"@"},controller:function($scope,$http){$scope.queryCities=function(query){return $http.get(SERVICE_PREFIX+"city",{params:{query:query}}).then(function(response){return response.data;});};$scope.formatInput=function(model){return nullOrEmpty(model)?model.name+" ("+model.state.name+")":"";};},templateUrl:"/template/widget/citySearch/citySearch.html"};});})();

angular.module('timeAgo',[]).directive("timeAgo",function($q){return{restrict:"C",scope:{title:'@'},link:function(scope,element,attrs){var parsedDate=$q.defer();parsedDate.promise.then(function(){jQuery(element).timeago();});attrs.$observe('title',function(newValue){parsedDate.resolve(newValue);});}};});
