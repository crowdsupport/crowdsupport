<div class="container-fluid place">
    <div class="row">
        <nav class="navbar">
            <p class="navbar-text">{{place.name}} @ {{place.location}}
                ({{place.city.name}})
            </p>

            <div class="navbar-right options form-inline">
                <div class="inline">
                    <input type="text" placeholder="Search for tags" class="form-control" ng-model="tagfilter" />
                </div>

                <div class="btn-group filtertoggle">
                    <label class="btn btn-default" ng-model="f.open" uib-btn-checkbox>Donations needed</label>
                    <label class="btn btn-warning" ng-model="f.enroute" uib-btn-checkbox>Enough en route</label>
                    <label class="btn btn-success" ng-model="f.done" uib-btn-checkbox>Done</label>
                </div>
                <span class="orga" ng-if="inTeam()">
                    <a href="/support/{{place.city.state.identifier}}/{{place.city.identifier}}/{{place.identifier}}/manage"><span
                            uib-tooltip="Manage place" class="btn glyphicon glyphicon-wrench"></span></a>
                    <a href="" ng-click="addRequest()"><span uib-tooltip="Add request" tooltip-append-to-body="true"
                                                             class="btn glyphicon glyphicon-plus"></span></a>
                </span>
            </div>
        </nav>
    </div>

    <div class="row" id="donationrequests" ng-controller="DonationRequestsCtrl">
        <div ng-repeat="req in donationRequests | filter : filter : true | orderBy : order" ng-class="req.ui.state"
             class="request col-lg-3 col-md-4 col-sm-6 col-xs-12 animate-repeat">
            <div class="panel panel-default panel-body">
                <div class="age">
                    <span ng-if="inTeam()">
                        <button class="btn btn-sm" uib-tooltip="Delete request" tooltip-append-to-body="true"
                                ng-click="deleteRequest(req.id)">
                            <span class="glyphicon glyphicon-remove"></span>
                        </button>
                        <button class="btn btn-sm" uib-tooltip="Mark request as resolved" tooltip-append-to-body="true"
                                ng-click="resolveRequest(req.id)">
                            <span class="glyphicon glyphicon-ok"></span>
                        </button>
                        <br/>
                    </span>
                    <time class="time-ago" datetime="{{req.createdDateTime}}"
                          uib-tooltip="{{req.createdDateTime | time}}" tooltip-append-to-body="true">
                        {{req.createdDateTime | time}}
                    </time>
                </div>


                <h3>{{req.title}}</h3>
                <p>{{req.description}}</p>

                <div ng-if="req.quantity">
                    <div class="justified-and-inlined">
                        <div>Need</div>
                        <div uib-tooltip-template="'tooltip.html'">
                            {{req.ui.quantityLeft | posNum}} {{req.units}} <span
                                ng-show="req.ui.quantityLeft != req.quantity">(of {{req.quantity}})</span>
                        </div>
                    </div>

                    <uib-progress>
                        <uib-bar value="req.ui.pConfirmed" type="success" class="progress-striped"
                                 uib-tooltip="Confirmed">
                            <span ng-hide="req.ui.pConfirmed < 20">{{req.ui.confirmed}}</span>
                        </uib-bar>
                        <uib-bar value="req.ui.pPromised" type="warning" class="progress-striped"
                                 uib-tooltip="En route">
                            <span ng-hide="req.ui.pPromised < 20">{{req.ui.promised}}</span>
                        </uib-bar>
                    </uib-progress>
                </div>

                <div class="tags" ng-if="req.tags">
                    Tags:
                    <span ng-repeat="tag in req.tags">
                        <span class="tag" ng-click="addTagToSearch(tag.name)">{{tag.name}}</span> <span ng-if="!$last">| </span>
                    </span>
                </div>

                <div class="justified-and-inlined" ng-if="req.validToDateTime">
                    <div>Expires</div>
                    <div>{{req.validToDateTime}}</div>
                </div>

                <div class="comments" ng-show="req.comments">
                    <div ng-repeat="comment in req.comments" ng-class="{done: comment.confirmed}" class="comment panel panel-default panel-body">
                        <div class="media">
                            <div class="media-left">
                                <div class="pic"></div>
                            </div>
                            <div class="media-body">
                                <b>{{comment.author.username}}</b>: {{comment.text}}

                                <p class="pull-right" ng-if="comment.quantity > 0">{{comment.quantity}}
                                    {{req.units}}</p>
                            </div>
                        </div>
                        <div ng-if="inTeam()" class="pull-right">
                            <button class="btn btn-xs" uib-tooltip="Delete comment" tooltip-append-to-body="true"
                                    ng-click="deleteComment(comment.id)">
                                <span class="glyphicon glyphicon-remove"></span>
                            </button>
                            <button class="btn btn-xs" uib-tooltip="Confirm donation" tooltip-append-to-body="true"
                                    ng-click="confirmComment(comment.id)" ng-if="!req.resolved">
                                <span class="glyphicon glyphicon-ok"></span>
                            </button>
                        </div>
                    </div>
                </div>

                <div class="well" ng-show="$root.user && !req.resolved">
                    <form ng-submit="req.ui.sendComment()" name="commentForm">
                        <div class="media">
                            <div class="media-left">
                                <div class="pic"></div>
                            </div>
                            <div class="media-body">
                                <b class="media-heading">{{$root.user.username}}</b>
                                <textarea class="form-control" placeholder="New comment..."
                                          ng-model="req.ui.commentText"></textarea>
                                <input class="form-control" type="number" placeholder="Qty"
                                       ng-model="req.ui.commentQuantity" ng-show="req.quantity"/>

                                <button class="pull-right btn btn-default"
                                        ng-disabled="req.ui.commentText.length === 0">Send
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<script type="text/ng-template" id="tooltip.html">
    <span>
        Confirmed: {{req.ui.confirmed}}<br/>
        En route: {{req.ui.promised}}
    </span>
</script>

<script type="text/ng-template" id="addRequest.html">
    <form ng-submit="create()" class="form-horizontal">
        <div class="modal-header">
            <h3 class="modal-title">Add new request</h3>
        </div>
        <div class="modal-body">
            <div class="form-group row">
                <label class="control-label col-sm-2" for="title">Title</label>
                <div class="col-sm-8">
                    <input type="text" class="form-control" id="title" placeholder="Title" ng-model="request.title"
                           required="required"/>
                </div>
            </div>
            <div class="form-group row">
                <label class="control-label col-sm-2" for="description">Description</label>
                <div class="col-sm-8">
                <textarea type="text" class="form-control" id="description" placeholder="Description"
                          ng-model="request.description" required="required"/>
                </div>
            </div>
            <div class="form-group row">
                <label class="control-label col-sm-2" for="validto">Valid to</label>
                <div class="col-sm-8" id="validto">
                    <input type="checkbox" class="" ng-model="neverExpires" id="neverExpires"/>
                    <label for="neverExpires" class="control-label">Never expires</label>

                    <div ng-hide="neverExpires">
                        <div class="input-group">
                            <input type="text" class="form-control" datetime-picker="dd.MM.yyyy HH:mm" ng-model="date"
                                   min-date="minDate" close-text="Close" is-open="opened" timepicker-options="timeOptions"
                                   ng-required="!neverExpires"/>
                                <span class="input-group-btn">
                                    <button type="button" class="btn btn-default" ng-click="opened = true"><i
                                            class="glyphicon glyphicon-calendar"></i></button>
                                </span>
                        </div>
                    </div>
                </div>
            </div>
            <div class="form-group">
                <label class="control-label col-sm-2" for="quantity">Quantity</label>
                <div class="col-sm-8">
                    <div class="row">
                        <div class="col-sm-3">
                            <input type="text" class="form-control" id="quantity"
                                   ng-model="request.quantity"/>
                        </div>
                        <div class="col-sm-9">
                            <input type="text" class="form-control" placeholder="Liters, bottles, people..."
                                   ng-model="request.units" ng-required="request.quantity"/>
                        </div>
                    </div>
                </div>
            </div>
            <div class="form-group">
                <label class="control-label col-sm-2" for="tag">Tags</label>
                <div class="col-sm-8">
                    <tag-search ng-model="inputTag" update-on-select="tag" input-class="form-control" input-id="tag"
                                omit-no-results="true" on-keypress="addTag"></tag-search>
                    <div>
                    <span ng-repeat="tag in request.tags">
                        <a ng-click="removeTag($index)" uib-tooltip="Remove tag">{{tag.name}}</a><span ng-hide="$last"> | </span>
                    </span>
                    </div>
                </div>
            </div>
        </div>
        <div class="modal-footer">
            <button type="submit" class="btn">
                <span class="glyphicon glyphicon-ok"></span>
            </button>
        </div>
    </form>
</script>